<%
  filter_params = %w[keyword lat is_bin used_ok pickup charity_support tax_receipt category_ids]
  has_location = params[:near_me] == "1" || (params[:near_me].blank? && params[:lat].present? && params[:lng].present?)
%>

<aside
  class="w-full lg:w-80 flex-shrink-0 hidden lg:block"
  data-controller="geo-search"
  data-filter-sidebar-target="sidebar"
  data-geo-search-poll-interval-value="<%= GeoTermsSearchController::POLL_INTERVAL_MS %>"
  data-geo-search-max-retries-value="<%= GeoTermsSearchController::MAX_RETRIES %>"
  data-geo-search-search-took-too-long-value="<%= t('views.places.geo_search.search_took_too_long') %>"
  data-geo-search-search-failed-value="<%= t('views.places.geo_search.search_failed') %>"
  data-geo-search-no-results-found-value="<%= t('views.places.geo_search.no_results_found') %>"
  data-geo-search-unknown-location-value="<%= t('views.places.geo_search.unknown_location') %>">

  <h3 class="font-semibold"><%= t('views.places.filter_sidebar.location.title') %></h3>
  <div class="divider mt-0"></div>

  <form>
    <div class="form-control mb-3 relative" data-geo-search-target="searchContainer">
      <div class="join w-full">
          <input
            type="text"
            class="input input-bordered join-item flex-1"
            placeholder="<%= t('views.places.geo_search.placeholder') %>"
            data-geo-search-target="input"
            value="<%= params[:keyword] %>"
            />
          <button type="submit" class="btn btn-secondary join-item" data-action="click->geo-search#search" data-geo-search-target="searchButton">
            <span class="loading loading-spinner loading-sm hidden" data-geo-search-target="loading"></span>
            <%= t('views.places.geo_search.button') %>
          </button>
      </div>

      <div class="hidden absolute top-full left-0 right-0 mt-2 z-50 bg-base-100 shadow-lg rounded-lg border border-base-300 max-h-96 overflow-y-auto" data-geo-search-target="resultsOverlay">
        <div class="p-2" data-geo-search-target="results"></div>
      </div>
    </div>
  </form>

  <div class="hidden alert alert-error mb-3" data-geo-search-target="error"></div>

  <%= form_with url: places_path,
                method: :get,
                class: "space-y-6",
                data: {
                  turbo_frame: "places_list",
                  turbo_action: "advance",
                  filter_sidebar_target: "form",
                  action: "submit->filter-sidebar#submitForm input->filter-sidebar#formChanged change->filter-sidebar#formChanged"
                } do |f| %>

    <%= render "shared/filter_fields", form: f, controller_prefix: "filter-sidebar", hide_location_header: true %>

    <div class="flex flex-col space-y-2">
      <% has_active_filters = filter_params.any? { |param| params[param].present? } %>
      <%= f.submit t('views.places.filter_sidebar.buttons.apply_filters'),
            class: "btn btn-secondary w-full", id: "apply_filters_btn", disabled: !has_active_filters, data: { filter_sidebar_target: "applyButton" } %>
      <button type="button" data-action="click->filter-sidebar#clearFilters" class="btn btn-ghost btn-sm w-full">
        <%= t('views.places.filter_sidebar.buttons.reset') %>
      </button>
    </div>
  <% end %>
</aside>
